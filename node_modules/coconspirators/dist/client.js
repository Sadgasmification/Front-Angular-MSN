"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const amqp = require("amqplib");
const events_1 = require("events");
const retry = require("retry");
const deferred_1 = require("./deferred");
class AmqpClient extends events_1.EventEmitter {
    /**
     * Creates an instance of AmqpClient.
     *
     * @memberof AmqpClient
     */
    constructor() {
        super();
        this.deferredConnection = new deferred_1.Deferred();
        this.connection = this.deferredConnection.promise;
        this.deferredChannel = new deferred_1.Deferred();
        this.channel = this.deferredChannel.promise;
    }
    /**
     * Connect to the queue
     *
     * @param {string} [uri='amqp://localhost:5672'] uri to amqp server
     * @param {amqp.Connection|Promise<amqp.Connection>} conn an already established connection or Promise to one
     * @returns {Promise<amqp.Connection>}
     * @memberof AmqpClient
     */
    connect(uri = 'amqp://localhost:5672', conn) {
        this.uri = uri;
        if (conn === undefined) {
            this.deferredConnection.resolve(this.createConnection(this.uri));
        }
        else {
            this.deferredConnection.resolve(conn);
        }
        this.setupListeners();
        this.deferredChannel.resolve(this.createChannel());
        return this.connection;
    }
    /**
     * Reconnect to the queue
     *
     * @returns {Promise<amqp.Connection>}
     * @memberof AmqpClient
     */
    async reconnect() {
        await this.disconnect();
        return this.connect(this.uri);
    }
    /**
     * Disconnect from the queue
     *
     * @returns {Promise<void>}
     * @memberof AmqpClient
     */
    async disconnect() {
        const conn = await this.connection;
        return conn.close();
    }
    /**
     * Create a channel
     *
     * @private
     * @returns {Promise<amqp.ConfirmChannel>}
     * @memberof AmqpClient
     */
    async createChannel(opts = {}) {
        return new Promise(async (resolve, reject) => {
            const connection = await this.connection;
            try {
                const channel = await connection.createConfirmChannel();
                // set prefetch
                if (opts.prefetch) {
                    await channel.prefetch(opts.prefetch);
                }
                resolve(channel);
            }
            catch (err) {
                this.emit(err);
                reject(err);
            }
        });
    }
    /**
     * Create a connection
     *
     * @private
     * @param {string} uri
     * @returns {Promise<amqp.Connection>}
     * @memberof AmqpClient
     */
    createConnection(uri) {
        return new Promise((resolve, reject) => {
            const operation = retry.operation();
            operation.attempt(async (attempt) => {
                try {
                    const connection = await amqp.connect(uri);
                    this.emit('connected');
                    resolve(connection);
                }
                catch (e) {
                    if (operation.retry(e))
                        return;
                    this.emit('error', e);
                    reject(e);
                }
            });
        });
    }
    /**
     * Setup listeners to connection events
     *
     * @private
     * @returns {Promise<void>}
     * @memberof AmqpClient
     */
    async setupListeners() {
        const connection = await this.connection;
        connection.once('close', (err) => {
            this.emit('disconnected', err);
        });
        connection.on('error', (err) => {
            this.emit('error', err);
            this.emit('disconnected', err);
        });
        process.on('SIGINT', () => {
            connection.close().then(() => {
                this.emit('disconnected');
                process.exit(0);
            }, (err) => {
                this.emit('error', err);
                this.emit('disconnected', err);
                process.exit(1);
            });
        });
    }
}
exports.AmqpClient = AmqpClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGdDQUFnQztBQUNoQyxtQ0FBc0M7QUFDdEMsK0JBQStCO0FBRy9CLHlDQUFzQztBQUV0QyxnQkFBd0IsU0FBUSxxQkFBWTtJQVMxQzs7OztPQUlHO0lBQ0g7UUFDRSxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLG1CQUFRLEVBQW1CLENBQUM7UUFDMUQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDO1FBRWxELElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxtQkFBUSxFQUF1QixDQUFDO1FBQzNELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUM7SUFDOUMsQ0FBQztJQUVEOzs7Ozs7O09BT0c7SUFDSCxPQUFPLENBQ0wsTUFBYyx1QkFBdUIsRUFDckMsSUFBK0M7UUFFL0MsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDZixJQUFJLElBQUksS0FBSyxTQUFTLEVBQUU7WUFDdEIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDbEU7YUFBTTtZQUNMLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDdkM7UUFFRCxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFFdEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUM7UUFFbkQsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQ3pCLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxTQUFTO1FBQ2IsTUFB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QUMxQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUNULElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxHQUFHLENBQUMsQ0FBQztnQkFDL0IsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBekpELGdDQXlKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFtcXAgZnJvbSAnYW1xcGxpYic7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0ICogYXMgcmV0cnkgZnJvbSAncmV0cnknO1xuXG5pbXBvcnQgeyBDaGFubmVsT3B0aW9ucyB9IGZyb20gJy4nO1xuaW1wb3J0IHsgRGVmZXJyZWQgfSBmcm9tICcuL2RlZmVycmVkJztcblxuZXhwb3J0IGNsYXNzIEFtcXBDbGllbnQgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuXG4gIGNvbm5lY3Rpb246IFByb21pc2U8YW1xcC5Db25uZWN0aW9uPjtcbiAgY2hhbm5lbDogUHJvbWlzZTxhbXFwLkNvbmZpcm1DaGFubmVsPjtcbiAgdXJpOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSBkZWZlcnJlZENvbm5lY3Rpb246IERlZmVycmVkPGFtcXAuQ29ubmVjdGlvbj47XG4gIHByaXZhdGUgZGVmZXJyZWRDaGFubmVsOiBEZWZlcnJlZDxhbXFwLkNvbmZpcm1DaGFubmVsPjtcblxuICAvKipcbiAgICogQ3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBBbXFwQ2xpZW50LlxuICAgKlxuICAgKiBAbWVtYmVyb2YgQW1xcENsaWVudFxuICAgKi9cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmRlZmVycmVkQ29ubmVjdGlvbiA9IG5ldyBEZWZlcnJlZDxhbXFwLkNvbm5lY3Rpb24+KCk7XG4gICAgdGhpcy5jb25uZWN0aW9uID0gdGhpcy5kZWZlcnJlZENvbm5lY3Rpb24ucHJvbWlzZTtcblxuICAgIHRoaXMuZGVmZXJyZWRDaGFubmVsID0gbmV3IERlZmVycmVkPGFtcXAuQ29uZmlybUNoYW5uZWw+KCk7XG4gICAgdGhpcy5jaGFubmVsID0gdGhpcy5kZWZlcnJlZENoYW5uZWwucHJvbWlzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25uZWN0IHRvIHRoZSBxdWV1ZVxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gW3VyaT0nYW1xcDovL2xvY2FsaG9zdDo1NjcyJ10gdXJpIHRvIGFtcXAgc2VydmVyXG4gICAqIEBwYXJhbSB7YW1xcC5Db25uZWN0aW9ufFByb21pc2U8YW1xcC5Db25uZWN0aW9uPn0gY29ubiBhbiBhbHJlYWR5IGVzdGFibGlzaGVkIGNvbm5lY3Rpb24gb3IgUHJvbWlzZSB0byBvbmVcbiAgICogQHJldHVybnMge1Byb21pc2U8YW1xcC5Db25uZWN0aW9uPn1cbiAgICogQG1lbWJlcm9mIEFtcXBDbGllbnRcbiAgICovXG4gIGNvbm5lY3QoXG4gICAgdXJpOiBzdHJpbmcgPSAnYW1xcDovL2xvY2FsaG9zdDo1NjcyJyxcbiAgICBjb25uPzogYW1xcC5Db25uZWN0aW9ufFByb21pc2U8YW1xcC5Db25uZWN0aW9uPlxuICApOiBQcm9taXNlPGFtcXAuQ29ubmVjdGlvbj4ge1xuICAgIHRoaXMudXJpID0gdXJpO1xuICAgIGlmIChjb25uID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuZGVmZXJyZWRDb25uZWN0aW9uLnJlc29sdmUodGhpcy5jcmVhdGVDb25uZWN0aW9uKHRoaXMudXJpKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGVmZXJyZWRDb25uZWN0aW9uLnJlc29sdmUoY29ubik7XG4gICAgfVxuXG4gICAgdGhpcy5zZXR1cExpc3RlbmVycygpO1xuXG4gICAgdGhpcy5kZWZlcnJlZENoYW5uZWwucmVzb2x2ZSh0aGlzLmNyZWF0ZUNoYW5uZWwoKSk7XG5cbiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlY29ubmVjdCB0byB0aGUgcXVldWVcbiAgICpcbiAgICogQHJldHVybnMge1Byb21pc2U8YW1xcC5Db25uZWN0aW9uPn1cbiAgICogQG1lbWJlcm9mIEFtcXBDbGllbnRcbiAgICovXG4gIGFzeW5jIHJlY29ubmVjdCgpOiBQcm9taXNlPGFtcXAuQ29ubmVjdGlvbj4ge1xuICAgIGF3YWl0IHRoaXMuZGlzY29ubmVjdCgpO1xuICAgIHJldHVybiB0aGlzLmNvbm5lY3QodGhpcy51cmkpO1xuICB9XG5cbiAgLyoqXG4gICAqIERpc2Nvbm5lY3QgZnJvbSB0aGUgcXVldWVcbiAgICpcbiAgICogQHJldHVybnMge1Byb21pc2U8dm9pZD59XG4gICAqIEBtZW1iZXJvZiBBbXFwQ2xpZW50XG4gICAqL1xuICBhc3luYyBkaXNjb25uZWN0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNvbm4gPSBhd2FpdCB0aGlzLmNvbm5lY3Rpb247XG4gICAgcmV0dXJuIGNvbm4uY2xvc2UoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBjaGFubmVsXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGFtcXAuQ29uZmlybUNoYW5uZWw+fVxuICAgKiBAbWVtYmVyb2YgQW1xcENsaWVudFxuICAgKi9cbiAgYXN5bmMgY3JlYXRlQ2hhbm5lbChvcHRzOiBDaGFubmVsT3B0aW9ucyA9IHt9KTogUHJvbWlzZTxhbXFwLkNvbmZpcm1DaGFubmVsPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGFtcXAuQ29uZmlybUNoYW5uZWw+KGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGNvbm5lY3Rpb24gPSBhd2FpdCB0aGlzLmNvbm5lY3Rpb247XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBjaGFubmVsID0gYXdhaXQgY29ubmVjdGlvbi5jcmVhdGVDb25maXJtQ2hhbm5lbCgpO1xuXG4gICAgICAgIC8vIHNldCBwcmVmZXRjaFxuICAgICAgICBpZiAob3B0cy5wcmVmZXRjaCkge1xuICAgICAgICAgIGF3YWl0IGNoYW5uZWwucHJlZmV0Y2gob3B0cy5wcmVmZXRjaCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXNvbHZlKGNoYW5uZWwpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRoaXMuZW1pdChlcnIpO1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBjb25uZWN0aW9uXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1cmlcbiAgICogQHJldHVybnMge1Byb21pc2U8YW1xcC5Db25uZWN0aW9uPn1cbiAgICogQG1lbWJlcm9mIEFtcXBDbGllbnRcbiAgICovXG4gIHByaXZhdGUgY3JlYXRlQ29ubmVjdGlvbih1cmk6IHN0cmluZyk6IFByb21pc2U8YW1xcC5Db25uZWN0aW9uPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGFtcXAuQ29ubmVjdGlvbj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3Qgb3BlcmF0aW9uID0gcmV0cnkub3BlcmF0aW9uKCk7XG5cbiAgICAgIG9wZXJhdGlvbi5hdHRlbXB0KGFzeW5jIChhdHRlbXB0KSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IGFtcXAuY29ubmVjdCh1cmkpO1xuICAgICAgICAgIHRoaXMuZW1pdCgnY29ubmVjdGVkJyk7XG5cbiAgICAgICAgICByZXNvbHZlKGNvbm5lY3Rpb24pO1xuICAgICAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgICBpZihvcGVyYXRpb24ucmV0cnkoZSkpIHJldHVybjtcbiAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZSk7XG4gICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXR1cCBsaXN0ZW5lcnMgdG8gY29ubmVjdGlvbiBldmVudHNcbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQHJldHVybnMge1Byb21pc2U8dm9pZD59XG4gICAqIEBtZW1iZXJvZiBBbXFwQ2xpZW50XG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHNldHVwTGlzdGVuZXJzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNvbm5lY3Rpb24gPSBhd2FpdCB0aGlzLmNvbm5lY3Rpb247XG4gICAgY29ubmVjdGlvbi5vbmNlKCdjbG9zZScsIChlcnIpID0+IHtcbiAgICAgIHRoaXMuZW1pdCgnZGlzY29ubmVjdGVkJywgZXJyKTtcbiAgICB9KTtcblxuICAgIGNvbm5lY3Rpb24ub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgICB0aGlzLmVtaXQoJ2Rpc2Nvbm5lY3RlZCcsIGVycik7XG4gICAgfSk7XG5cbiAgICBwcm9jZXNzLm9uKCdTSUdJTlQnLCAoKSA9PiB7XG4gICAgICBjb25uZWN0aW9uLmNsb3NlKCkudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXMuZW1pdCgnZGlzY29ubmVjdGVkJyk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgICAgIHRoaXMuZW1pdCgnZGlzY29ubmVjdGVkJywgZXJyKTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==