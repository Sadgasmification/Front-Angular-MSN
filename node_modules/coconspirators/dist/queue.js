"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const events_1 = require("events");
const shortid = require("shortid");
const types_1 = require("./types");
class AmqpQueue extends events_1.EventEmitter {
    /**
     * Creates an instance of AmqpQueue.
     * @param {AmqpClient} client
     * @param {QueueOptions} [options]
     * @memberof AmqpQueue
     */
    constructor(client, options) {
        super();
        this.client = client;
        this.options = {
            exchange: '',
            durable: false,
            noAck: true
        };
        // if decorated, get decorations and merge
        const metadata = Reflect.getMetadata(types_1.NAME_KEY, this);
        if (metadata) {
            Object.assign(this.options, metadata);
        }
        // if options passed in manually, extend options
        if (options) {
            Object.assign(this.options, options);
        }
        // do we need our own channel?
        if (this.options.channel) {
            this.channel = this.client.createChannel(this.options.channel);
        }
        else {
            this.channel = this.client.channel;
        }
        this.queue = this.createQueue();
    }
    /**
     * Subscribe to a channel
     *
     * @param {(message: ReplyableMessage) => void} callback
     * @param {SubscribeOptions} [options={}]
     * @returns {Promise<amqp.Replies.Consume>}
     * @memberof AmqpQueue
     */
    async subscribe(callback, options = {}) {
        const chnl = await this.channel;
        const opts = Object.assign({}, this.options, options);
        return chnl.consume(this.options.name || '', async (message) => {
            if (opts.contentType === 'application/json') {
                message.body = JSON.parse(message.content.toString());
            }
            message.reply = (content) => {
                return this.reply(content, {
                    replyTo: message.properties.replyTo,
                    correlationId: message.properties.correlationId
                });
            };
            message.ack = () => {
                this.ack(message);
            };
            callback(message);
        }, opts);
    }
    /**
     * Publish content to a queue
     *
     * @param {*} content
     * @param {PublishOptions} [options={}]
     * @returns {Promise<{ content: any; properties: PublishOptions }>}
     * @memberof AmqpQueue
     */
    async publish(content, options = {}) {
        const chnl = await this.channel;
        const opts = Object.assign({}, this.options, options);
        if (this.rpcQueue) {
            opts.correlationId = shortid.generate();
            opts.replyTo = (await this.rpcQueue).queue;
        }
        if (opts.contentType === 'application/json') {
            const json = JSON.stringify(content);
            content = new Buffer(json);
        }
        const exchange = options.exchangeOverride === '' || options.exchangeOverride ?
            options.exchangeOverride :
            this.options.exchange;
        chnl.publish(exchange || '', options.routingKey || this.options.name || '', content, opts);
        return {
            content,
            properties: opts
        };
    }
    /**
     * Reply to a message by id or message
     *
     * @param {(string|amqp.Message)} idOrMessage
     * @returns {Promise<amqp.Message>}
     * @memberof AmqpQueue
     */
    async replyOf(idOrMessage) {
        const id = typeof idOrMessage !== 'string' ? idOrMessage.properties.correlationId : idOrMessage;
        return new Promise((resolve, reject) => {
            this.once(id, (message) => {
                if (this.options.contentType === 'application/json') {
                    try {
                        message.content = JSON.parse(message.content.toString());
                    }
                    catch (e) { /* do nothing */ }
                }
                resolve(message);
            });
        });
    }
    /**
     * Reply to a channel
     *
     * @param {*} content
     * @param {ReplyOptions} [options={}]
     * @returns {Promise<{ content: any, properties: ReplyOptions }>}
     * @memberof AmqpQueue
     */
    async reply(content, options) {
        const chnl = await this.channel;
        if (this.options.contentType === 'application/json') {
            const json = JSON.stringify(content);
            content = new Buffer(json);
        }
        chnl.sendToQueue(options.replyTo, content, options);
        return {
            content,
            properties: options
        };
    }
    /**
     * Bind queue to exchange
     *
     * @param {string} queue
     * @param {string} routingKey
     * @param {*} [opts={}]
     * @memberOf AmqpQueue
     */
    async bindQueue(queue, routingKey, opts = {}) {
        const chnl = await this.channel;
        await chnl.bindQueue(queue, this.options.exchange || '', routingKey, opts);
        return {
            queue,
            exchange: this.options.exchange || '',
            routingKey
        };
    }
    /**
     * Unbind queue from exchange
     *
     * @param {string} queue
     * @param {string} routingKey
     * @param {*} [opts={}]
     * @memberOf AmqpQueue
     */
    async unbindQueue(queue, routingKey, opts = {}) {
        const chnl = await this.channel;
        await chnl.unbindQueue(queue, this.options.exchange || '', routingKey, opts);
        return {
            queue,
            exchange: this.options.exchange || '',
            routingKey
        };
    }
    /**
     * Acknowledge a message
     *
     * @param {amqp.Message} message
     * @returns {Promise<void>}
     * @memberof AmqpQueue
     */
    async ack(message) {
        const chnl = await this.channel;
        chnl.ack(message);
    }
    /**
     * Purge the queue
     *
     * @returns {Promise<amqp.Replies.PurgeQueue>}
     * @memberof AmqpQueue
     */
    async purge() {
        const chnl = await this.channel;
        return chnl.purgeQueue(this.options.name || '');
    }
    /**
     * Create a queue
     *
     * @private
     * @returns {Promise<amqp.Replies.AssertQueue>}
     * @memberof AmqpQueue
     */
    createQueue() {
        return new Promise(async (resolve, reject) => {
            try {
                const chnl = await this.channel;
                const queue = await chnl.assertQueue(this.options.name || '', this.options);
                await this.consumeReplies();
                resolve(queue);
            }
            catch (e) {
                reject(e);
            }
        });
    }
    /**
     * Consume any replies on the queue
     *
     * @private
     * @returns {Promise<void>}
     * @memberof AmqpQueue
     */
    async consumeReplies() {
        if (!this.options.rpc)
            return;
        const chnl = await this.channel;
        // Wrap Bluebird in native Promise
        this.rpcQueue = new Promise((resolve, reject) => {
            chnl.assertQueue('', {
                exclusive: this.options.exclusive
            }).then(resolve, reject);
        });
        chnl.consume((await this.rpcQueue).queue, (result) => {
            if (result)
                this.emit(result.properties.correlationId, result);
        }, { noAck: true });
    }
}
exports.AmqpQueue = AmqpQueue;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVldWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcXVldWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSxtQ0FBc0M7QUFDdEMsbUNBQW1DO0FBR25DLG1DQUVpQjtBQUVqQixlQUFtQyxTQUFRLHFCQUFZO0lBV3JEOzs7OztPQUtHO0lBQ0gsWUFBb0IsTUFBa0IsRUFBRSxPQUFzQjtRQUM1RCxLQUFLLEVBQUUsQ0FBQztRQURVLFdBQU0sR0FBTixNQUFNLENBQVk7UUFadEMsWUFBTyxHQUFpQjtZQUN0QixRQUFRLEVBQUUsRUFBRTtZQUNaLE9BQU8sRUFBRSxLQUFLO1lBQ2QsS0FBSyxFQUFFLElBQUk7U0FDWixDQUFDO1FBV0EsMENBQTBDO1FBQzFDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsZ0JBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNyRCxJQUFHLFFBQVEsRUFBRTtZQUNYLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztTQUN2QztRQUVELGdEQUFnRDtRQUNoRCxJQUFHLE9BQU8sRUFBRTtZQUNWLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztTQUN0QztRQUVELDhCQUE4QjtRQUM5QixJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFO1lBQ3hCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUNoRTthQUFNO1lBQ0wsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQztTQUNwQztRQUVELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2xDLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lB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O0FBNVFELDhCQTRRQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFtcXAgZnJvbSAnYW1xcGxpYic7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0ICogYXMgc2hvcnRpZCBmcm9tICdzaG9ydGlkJztcblxuaW1wb3J0IHsgQW1xcENsaWVudCB9IGZyb20gJy4vY2xpZW50JztcbmltcG9ydCB7XG4gICAgTkFNRV9LRVksIFB1Ymxpc2hPcHRpb25zLCBRdWV1ZU9wdGlvbnMsIFJlcGx5YWJsZU1lc3NhZ2UsIFJlcGx5T3B0aW9ucywgU3Vic2NyaWJlT3B0aW9uc1xufSBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IGNsYXNzIEFtcXBRdWV1ZTxUID0gQnVmZmVyPiBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG5cbiAgY2hhbm5lbDogUHJvbWlzZTxhbXFwLkNvbmZpcm1DaGFubmVsPjtcbiAgcXVldWU6IFByb21pc2U8YW1xcC5SZXBsaWVzLkFzc2VydFF1ZXVlPjtcbiAgcnBjUXVldWU6IFByb21pc2U8YW1xcC5SZXBsaWVzLkFzc2VydFF1ZXVlPjtcbiAgb3B0aW9uczogUXVldWVPcHRpb25zID0ge1xuICAgIGV4Y2hhbmdlOiAnJyxcbiAgICBkdXJhYmxlOiBmYWxzZSxcbiAgICBub0FjazogdHJ1ZVxuICB9O1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFuIGluc3RhbmNlIG9mIEFtcXBRdWV1ZS5cbiAgICogQHBhcmFtIHtBbXFwQ2xpZW50fSBjbGllbnRcbiAgICogQHBhcmFtIHtRdWV1ZU9wdGlvbnN9IFtvcHRpb25zXVxuICAgKiBAbWVtYmVyb2YgQW1xcFF1ZXVlXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNsaWVudDogQW1xcENsaWVudCwgb3B0aW9ucz86IFF1ZXVlT3B0aW9ucykge1xuICAgIHN1cGVyKCk7XG5cbiAgICAvLyBpZiBkZWNvcmF0ZWQsIGdldCBkZWNvcmF0aW9ucyBhbmQgbWVyZ2VcbiAgICBjb25zdCBtZXRhZGF0YSA9IFJlZmxlY3QuZ2V0TWV0YWRhdGEoTkFNRV9LRVksIHRoaXMpO1xuICAgIGlmKG1ldGFkYXRhKSB7XG4gICAgICBPYmplY3QuYXNzaWduKHRoaXMub3B0aW9ucywgbWV0YWRhdGEpO1xuICAgIH1cblxuICAgIC8vIGlmIG9wdGlvbnMgcGFzc2VkIGluIG1hbnVhbGx5LCBleHRlbmQgb3B0aW9uc1xuICAgIGlmKG9wdGlvbnMpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5vcHRpb25zLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICAvLyBkbyB3ZSBuZWVkIG91ciBvd24gY2hhbm5lbD9cbiAgICBpZiAodGhpcy5vcHRpb25zLmNoYW5uZWwpIHtcbiAgICAgIHRoaXMuY2hhbm5lbCA9IHRoaXMuY2xpZW50LmNyZWF0ZUNoYW5uZWwodGhpcy5vcHRpb25zLmNoYW5uZWwpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNoYW5uZWwgPSB0aGlzLmNsaWVudC5jaGFubmVsO1xuICAgIH1cblxuICAgIHRoaXMucXVldWUgPSB0aGlzLmNyZWF0ZVF1ZXVlKCk7XG4gIH1cblxuICAvKipcbiAgICogU3Vic2NyaWJlIHRvIGEgY2hhbm5lbFxuICAgKlxuICAgKiBAcGFyYW0geyhtZXNzYWdlOiBSZXBseWFibGVNZXNzYWdlKSA9PiB2b2lkfSBjYWxsYmFja1xuICAgKiBAcGFyYW0ge1N1YnNjcmliZU9wdGlvbnN9IFtvcHRpb25zPXt9XVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxhbXFwLlJlcGxpZXMuQ29uc3VtZT59XG4gICAqIEBtZW1iZXJvZiBBbXFwUXVldWVcbiAgICovXG4gIGFzeW5jIHN1YnNjcmliZShcbiAgICBjYWxsYmFjazogKG1lc3NhZ2U6IFJlcGx5YWJsZU1lc3NhZ2U8VD4pID0+IHZvaWQsXG4gICAgb3B0aW9uczogU3Vic2NyaWJlT3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8YW1xcC5SZXBsaWVzLkNvbnN1bWU+IHtcbiAgICBjb25zdCBjaG5sID0gYXdhaXQgdGhpcy5jaGFubmVsO1xuICAgIGNvbnN0IG9wdHM6IGFueSA9IHsgLi4udGhpcy5vcHRpb25zLCAuLi5vcHRpb25zIH07XG5cbiAgICByZXR1cm4gY2hubC5jb25zdW1lKHRoaXMub3B0aW9ucy5uYW1lIHx8ICcnLCBhc3luYyAobWVzc2FnZTogUmVwbHlhYmxlTWVzc2FnZTxUPikgPT4ge1xuICAgICAgaWYob3B0cy5jb250ZW50VHlwZSA9PT0gJ2FwcGxpY2F0aW9uL2pzb24nKSB7XG4gICAgICAgIG1lc3NhZ2UuYm9keSA9IEpTT04ucGFyc2UobWVzc2FnZS5jb250ZW50LnRvU3RyaW5nKCkpO1xuICAgICAgfVxuXG4gICAgICBtZXNzYWdlLnJlcGx5ID0gKGNvbnRlbnQ6IGFueSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5yZXBseShjb250ZW50LCB7XG4gICAgICAgICAgcmVwbHlUbzogbWVzc2FnZS5wcm9wZXJ0aWVzLnJlcGx5VG8sXG4gICAgICAgICAgY29ycmVsYXRpb25JZDogbWVzc2FnZS5wcm9wZXJ0aWVzLmNvcnJlbGF0aW9uSWRcbiAgICAgICAgfSk7XG4gICAgICB9O1xuXG4gICAgICBtZXNzYWdlLmFjayA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5hY2sobWVzc2FnZSk7XG4gICAgICB9O1xuXG4gICAgICBjYWxsYmFjayhtZXNzYWdlKTtcbiAgICB9LCBvcHRzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQdWJsaXNoIGNvbnRlbnQgdG8gYSBxdWV1ZVxuICAgKlxuICAgKiBAcGFyYW0geyp9IGNvbnRlbnRcbiAgICogQHBhcmFtIHtQdWJsaXNoT3B0aW9uc30gW29wdGlvbnM9e31dXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHsgY29udGVudDogYW55OyBwcm9wZXJ0aWVzOiBQdWJsaXNoT3B0aW9ucyB9Pn1cbiAgICogQG1lbWJlcm9mIEFtcXBRdWV1ZVxuICAgKi9cbiAgYXN5bmMgcHVibGlzaChjb250ZW50OiBhbnksIG9wdGlvbnM6IFB1Ymxpc2hPcHRpb25zID0ge30pOiBQcm9taXNlPHsgY29udGVudDogYW55OyBwcm9wZXJ0aWVzOiBQdWJsaXNoT3B0aW9ucyB9PiB7XG4gICAgY29uc3QgY2hubCA9IGF3YWl0IHRoaXMuY2hhbm5lbDtcbiAgICBjb25zdCBvcHRzOiBhbnkgPSB7IC4uLnRoaXMub3B0aW9ucywgLi4ub3B0aW9uc307XG5cbiAgICBpZih0aGlzLnJwY1F1ZXVlKSB7XG4gICAgICBvcHRzLmNvcnJlbGF0aW9uSWQgPSBzaG9ydGlkLmdlbmVyYXRlKCk7XG4gICAgICBvcHRzLnJlcGx5VG8gPSAoYXdhaXQgdGhpcy5ycGNRdWV1ZSkucXVldWU7XG4gICAgfVxuXG4gICAgaWYob3B0cy5jb250ZW50VHlwZSA9PT0gJ2FwcGxpY2F0aW9uL2pzb24nKSB7XG4gICAgICBjb25zdCBqc29uID0gSlNPTi5zdHJpbmdpZnkoY29udGVudCk7XG4gICAgICBjb250ZW50ID0gbmV3IEJ1ZmZlcihqc29uKTtcbiAgICB9XG5cbiAgICBjb25zdCBleGNoYW5nZSA9IG9wdGlvbnMuZXhjaGFuZ2VPdmVycmlkZSA9PT0gJycgfHwgb3B0aW9ucy5leGNoYW5nZU92ZXJyaWRlID9cbiAgICAgIG9wdGlvbnMuZXhjaGFuZ2VPdmVycmlkZSA6XG4gICAgICB0aGlzLm9wdGlvbnMuZXhjaGFuZ2U7XG5cbiAgICBjaG5sLnB1Ymxpc2goXG4gICAgICBleGNoYW5nZSB8fCAnJyxcbiAgICAgIG9wdGlvbnMucm91dGluZ0tleSB8fCB0aGlzLm9wdGlvbnMubmFtZSB8fCAnJyxcbiAgICAgIGNvbnRlbnQsXG4gICAgICBvcHRzXG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICBjb250ZW50LFxuICAgICAgcHJvcGVydGllczogb3B0c1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUmVwbHkgdG8gYSBtZXNzYWdlIGJ5IGlkIG9yIG1lc3NhZ2VcbiAgICpcbiAgICogQHBhcmFtIHsoc3RyaW5nfGFtcXAuTWVzc2FnZSl9IGlkT3JNZXNzYWdlXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGFtcXAuTWVzc2FnZT59XG4gICAqIEBtZW1iZXJvZiBBbXFwUXVldWVcbiAgICovXG4gIGFzeW5jIHJlcGx5T2YoaWRPck1lc3NhZ2U6IHN0cmluZ3xhbXFwLk1lc3NhZ2UpOiBQcm9taXNlPGFtcXAuTWVzc2FnZT4ge1xuICAgIGNvbnN0IGlkID0gdHlwZW9mIGlkT3JNZXNzYWdlICE9PSAnc3RyaW5nJyA/IChpZE9yTWVzc2FnZSBhcyBhbXFwLk1lc3NhZ2UpLnByb3BlcnRpZXMuY29ycmVsYXRpb25JZCA6IGlkT3JNZXNzYWdlO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGFtcXAuTWVzc2FnZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5vbmNlKGlkLCAobWVzc2FnZTogYW1xcC5NZXNzYWdlKSA9PiB7XG4gICAgICAgIGlmKHRoaXMub3B0aW9ucy5jb250ZW50VHlwZSA9PT0gJ2FwcGxpY2F0aW9uL2pzb24nKSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIG1lc3NhZ2UuY29udGVudCA9IEpTT04ucGFyc2UobWVzc2FnZS5jb250ZW50LnRvU3RyaW5nKCkpO1xuICAgICAgICAgIH0gY2F0Y2goZSkgeyAvKiBkbyBub3RoaW5nICovIH1cbiAgICAgICAgfVxuICAgICAgICByZXNvbHZlKG1lc3NhZ2UpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmVwbHkgdG8gYSBjaGFubmVsXG4gICAqXG4gICAqIEBwYXJhbSB7Kn0gY29udGVudFxuICAgKiBAcGFyYW0ge1JlcGx5T3B0aW9uc30gW29wdGlvbnM9e31dXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHsgY29udGVudDogYW55LCBwcm9wZXJ0aWVzOiBSZXBseU9wdGlvbnMgfT59XG4gICAqIEBtZW1iZXJvZiBBbXFwUXVldWVcbiAgICovXG4gIGFzeW5jIHJlcGx5KGNvbnRlbnQ6IGFueSwgb3B0aW9uczogUmVwbHlPcHRpb25zKTogUHJvbWlzZTx7IGNvbnRlbnQ6IGFueSwgcHJvcGVydGllczogUmVwbHlPcHRpb25zIH0+IHtcbiAgICBjb25zdCBjaG5sID0gYXdhaXQgdGhpcy5jaGFubmVsO1xuXG4gICAgaWYodGhpcy5vcHRpb25zLmNvbnRlbnRUeXBlID09PSAnYXBwbGljYXRpb24vanNvbicpIHtcbiAgICAgIGNvbnN0IGpzb24gPSBKU09OLnN0cmluZ2lmeShjb250ZW50KTtcbiAgICAgIGNvbnRlbnQgPSBuZXcgQnVmZmVyKGpzb24pO1xuICAgIH1cblxuICAgIGNobmwuc2VuZFRvUXVldWUob3B0aW9ucy5yZXBseVRvLCBjb250ZW50LCBvcHRpb25zKTtcblxuICAgIHJldHVybiB7XG4gICAgICBjb250ZW50LFxuICAgICAgcHJvcGVydGllczogb3B0aW9uc1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQmluZCBxdWV1ZSB0byBleGNoYW5nZVxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gcXVldWVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHJvdXRpbmdLZXlcbiAgICogQHBhcmFtIHsqfSBbb3B0cz17fV1cbiAgICogQG1lbWJlck9mIEFtcXBRdWV1ZVxuICAgKi9cbiAgYXN5bmMgYmluZFF1ZXVlKHF1ZXVlOiBzdHJpbmcsIHJvdXRpbmdLZXk6IHN0cmluZywgb3B0czogYW55ID0ge30pIHtcbiAgICBjb25zdCBjaG5sID0gYXdhaXQgdGhpcy5jaGFubmVsO1xuXG4gICAgYXdhaXQgY2hubC5iaW5kUXVldWUocXVldWUsIHRoaXMub3B0aW9ucy5leGNoYW5nZSB8fCAnJywgcm91dGluZ0tleSwgb3B0cyk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgcXVldWUsXG4gICAgICBleGNoYW5nZTogdGhpcy5vcHRpb25zLmV4Y2hhbmdlIHx8ICcnLFxuICAgICAgcm91dGluZ0tleVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogVW5iaW5kIHF1ZXVlIGZyb20gZXhjaGFuZ2VcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHF1ZXVlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSByb3V0aW5nS2V5XG4gICAqIEBwYXJhbSB7Kn0gW29wdHM9e31dXG4gICAqIEBtZW1iZXJPZiBBbXFwUXVldWVcbiAgICovXG4gIGFzeW5jIHVuYmluZFF1ZXVlKHF1ZXVlOiBzdHJpbmcsIHJvdXRpbmdLZXk6IHN0cmluZywgb3B0czogYW55ID0ge30pIHtcbiAgICBjb25zdCBjaG5sID0gYXdhaXQgdGhpcy5jaGFubmVsO1xuXG4gICAgYXdhaXQgY2hubC51bmJpbmRRdWV1ZShxdWV1ZSwgdGhpcy5vcHRpb25zLmV4Y2hhbmdlIHx8ICcnLCByb3V0aW5nS2V5LCBvcHRzKTtcblxuICAgIHJldHVybiB7XG4gICAgICBxdWV1ZSxcbiAgICAgIGV4Y2hhbmdlOiB0aGlzLm9wdGlvbnMuZXhjaGFuZ2UgfHwgJycsXG4gICAgICByb3V0aW5nS2V5XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBY2tub3dsZWRnZSBhIG1lc3NhZ2VcbiAgICpcbiAgICogQHBhcmFtIHthbXFwLk1lc3NhZ2V9IG1lc3NhZ2VcbiAgICogQHJldHVybnMge1Byb21pc2U8dm9pZD59XG4gICAqIEBtZW1iZXJvZiBBbXFwUXVldWVcbiAgICovXG4gIGFzeW5jIGFjayhtZXNzYWdlOiBhbXFwLk1lc3NhZ2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBjaG5sID0gYXdhaXQgdGhpcy5jaGFubmVsO1xuICAgIGNobmwuYWNrKG1lc3NhZ2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIFB1cmdlIHRoZSBxdWV1ZVxuICAgKlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxhbXFwLlJlcGxpZXMuUHVyZ2VRdWV1ZT59XG4gICAqIEBtZW1iZXJvZiBBbXFwUXVldWVcbiAgICovXG4gIGFzeW5jIHB1cmdlKCk6IFByb21pc2U8YW1xcC5SZXBsaWVzLlB1cmdlUXVldWU+IHtcbiAgICBjb25zdCBjaG5sID0gYXdhaXQgdGhpcy5jaGFubmVsO1xuICAgIHJldHVybiBjaG5sLnB1cmdlUXVldWUodGhpcy5vcHRpb25zLm5hbWUgfHwgJycpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIHF1ZXVlXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGFtcXAuUmVwbGllcy5Bc3NlcnRRdWV1ZT59XG4gICAqIEBtZW1iZXJvZiBBbXFwUXVldWVcbiAgICovXG4gIHByaXZhdGUgY3JlYXRlUXVldWUoKTogUHJvbWlzZTxhbXFwLlJlcGxpZXMuQXNzZXJ0UXVldWU+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY2hubCA9IGF3YWl0IHRoaXMuY2hhbm5lbDtcbiAgICAgICAgY29uc3QgcXVldWUgPSBhd2FpdCBjaG5sLmFzc2VydFF1ZXVlKHRoaXMub3B0aW9ucy5uYW1lIHx8ICcnLCB0aGlzLm9wdGlvbnMpO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuY29uc3VtZVJlcGxpZXMoKTtcbiAgICAgICAgcmVzb2x2ZShxdWV1ZSk7XG4gICAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnN1bWUgYW55IHJlcGxpZXMgb24gdGhlIHF1ZXVlXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHZvaWQ+fVxuICAgKiBAbWVtYmVyb2YgQW1xcFF1ZXVlXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGNvbnN1bWVSZXBsaWVzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmKCF0aGlzLm9wdGlvbnMucnBjKSByZXR1cm47XG5cbiAgICBjb25zdCBjaG5sID0gYXdhaXQgdGhpcy5jaGFubmVsO1xuICAgIC8vIFdyYXAgQmx1ZWJpcmQgaW4gbmF0aXZlIFByb21pc2VcbiAgICB0aGlzLnJwY1F1ZXVlID0gbmV3IFByb21pc2U8YW1xcC5SZXBsaWVzLkFzc2VydFF1ZXVlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjaG5sLmFzc2VydFF1ZXVlKCcnLCB7XG4gICAgICAgIGV4Y2x1c2l2ZTogdGhpcy5vcHRpb25zLmV4Y2x1c2l2ZVxuICAgICAgfSkudGhlbihyZXNvbHZlLCByZWplY3QpO1xuICAgIH0pO1xuXG4gICAgY2hubC5jb25zdW1lKChhd2FpdCB0aGlzLnJwY1F1ZXVlKS5xdWV1ZSwgKHJlc3VsdCkgPT4ge1xuICAgICAgaWYgKHJlc3VsdCkgdGhpcy5lbWl0KHJlc3VsdC5wcm9wZXJ0aWVzLmNvcnJlbGF0aW9uSWQsIHJlc3VsdCk7XG4gICAgfSwgeyBub0FjazogdHJ1ZSB9KTtcbiAgfVxuXG59XG4iXX0=