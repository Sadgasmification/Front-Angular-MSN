"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const events_1 = require("events");
const types_1 = require("./types");
class AmqpExchange extends events_1.EventEmitter {
    /**
     * Creates an instance of AmqpExchange.
     * @param {AmqpClient} client
     * @param {QueueOptions} [options]
     * @memberof AmqpExchange
     */
    constructor(client, options) {
        super();
        this.client = client;
        // if decorated, get decorations and merge
        const metadata = Reflect.getMetadata(types_1.NAME_KEY, this);
        if (metadata) {
            this.options = metadata;
        }
        // if options passed in manually, extend options
        if (options) {
            Object.assign(this.options, options);
        }
        this.name = this.options.name;
        // do we need our own channel?
        if (this.options.channel) {
            this.channel = this.client.createChannel(this.options.channel);
        }
        else {
            this.channel = client.channel;
        }
        this.exchange = this.createExchange();
    }
    /**
     * Publish a message to the Exchange
     *
     * @param {T} content The content of the message
     * @param {string} [routingKey=''] The routing key for the message
     * @param {amqp.Options.Publish} [options={}] Any options added to message
     * @returns {Promise<boolean>} True if message accepted, false if write buffer is full
     * @memberof AmqpExchange
     */
    async publish(content, routingKey = '', options = {}) {
        const chnl = await this.channel;
        await this.exchange; // wait for exchange to be asserted
        let buf;
        if (this.options.contentType === 'application/json') {
            const json = JSON.stringify(content);
            buf = new Buffer(json);
        }
        else {
            buf = new Buffer(content.toString());
        }
        return chnl.publish(this.name, routingKey, buf, options);
    }
    /**
     * Deletes the exchange
     *
     * @param {amqp.Options.DeleteExchange} [options] { ifUnused: true|false }
     * @returns {Promise<void>}
     * @memberof AmqpExchange
     */
    async deleteExchange(options) {
        const chnl = await this.channel;
        await this.exchange; // wait for exchange to be asserted
        await chnl.deleteExchange(this.name, options);
    }
    /**
     * Bind this exchange to another exchange
     *
     * @param {string} destination The name of the destination exchange
     * @param {string} pattern The pattern to match messages to send
     * @param {*} [args] Any arguments (headers, etc)
     * @returns {Promise<void>}
     * @memberof AmqpExchange
     */
    async bindExchange(destination, pattern, args) {
        const chnl = await this.channel;
        await this.exchange; // wait for exchange to be asserted
        await chnl.bindExchange(destination, this.name, pattern, args);
    }
    /**
     * Unbind an exchange to this exchange
     * The destination, pattern, and args must match those given when exchange was bound
     *
     * @param {string} destination The name of the destination exchange
     * @param {string} pattern The pattern to match message to send
     * @param {*} [args] Any arguments (headers, etc)
     * @returns {Promise<void>}
     * @memberof AmqpExchange
     */
    async unbindExchange(destination, pattern, args) {
        const chnl = await this.channel;
        await this.exchange; // wait for exchange to be asserted
        await chnl.unbindExchange(destination, this.name, pattern, args);
    }
    /**
     * Bind a queue to this exchange
     *
     * @param {string} queue The name of the queue
     * @param {string} pattern The pattern to match message to send
     * @param {*} [args] Any arguements (headers, etc)
     * @returns {Promise<void>}
     * @memberof AmqpExchange
     */
    async bindQueue(queue, pattern, args) {
        const chnl = await this.channel;
        await this.exchange; // wait for exchange to be asserted
        await chnl.bindQueue(queue, this.name, pattern, args);
    }
    /**
     * Unbind a queue to this exchange
     * The destination, pattern, and args must match those given when queue was bound
     *
     * @param {string} queue The name of the queue
     * @param {string} pattern The pattern to match message to send
     * @param {*} [args] Any arguements (headers, etc)
     * @returns {Promise<amqp.Replies.Empty>}
     * @memberof AmqpExchange
     */
    async unbindQueue(queue, pattern, args) {
        const chnl = await this.channel;
        await this.exchange; // wait for exchange to be asserted
        await chnl.unbindQueue(queue, this.name, pattern, args);
    }
    /**
     * Create the Exchange
     *
     * @private
     * @returns {Promise<amqp.Replies.AssertExchange>}
     * @memberof AmqpExchange
     */
    createExchange() {
        return new Promise(async (resolve, reject) => {
            try {
                const chnl = await this.channel;
                const exchange = await chnl.assertExchange(this.options.name, this.options.type, this.options);
                resolve(exchange);
            }
            catch (e) {
                reject(e);
            }
        });
    }
}
exports.AmqpExchange = AmqpExchange;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhjaGFuZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZXhjaGFuZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSxtQ0FBc0M7QUFHdEMsbUNBQW9EO0FBRXBELGtCQUE2QixTQUFRLHFCQUFZO0lBTy9DOzs7OztPQUtHO0lBQ0gsWUFBb0IsTUFBa0IsRUFBRSxPQUF5QjtRQUMvRCxLQUFLLEVBQUUsQ0FBQztRQURVLFdBQU0sR0FBTixNQUFNLENBQVk7UUFHcEMsMENBQTBDO1FBQzFDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsZ0JBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNyRCxJQUFJLFFBQVEsRUFBRTtZQUNaLElBQUksQ0FBQyxPQUFPLEdBQUksUUFBUSxDQUFDO1NBQzFCO1FBRUQsZ0RBQWdEO1FBQ2hELElBQUksT0FBTyxFQUFFO1lBQ1gsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ3RDO1FBRUQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztRQUU5Qiw4QkFBOEI7UUFDOUIsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTtZQUN4QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDaEU7YUFBTTtZQUNMLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQztTQUMvQjtRQUVELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFFRDs7Ozs7Ozs7T0FRRztJQUNILEtBQUssQ0FBQyxPQUFPLENBQ1gsT0FBVSxFQUNWLGFBQXFCLEVBQUUsRUFDdkIsVUFBZ0MsRUFBRTtRQUVsQyxNQUFN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QkFDaEMsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFFL0YsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ25CO1lBQUMsT0FBTSxDQUFDLEVBQUU7Z0JBQ1QsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ1g7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FFRjtBQXhLRCxvQ0F3S0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBhbXFwIGZyb20gJ2FtcXBsaWInO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcblxuaW1wb3J0IHsgQW1xcENsaWVudCB9IGZyb20gJy4vY2xpZW50JztcbmltcG9ydCB7IEV4Y2hhbmdlT3B0aW9ucywgTkFNRV9LRVkgfSBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IGNsYXNzIEFtcXBFeGNoYW5nZTxUPiBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG5cbiAgY2hhbm5lbDogUHJvbWlzZTxhbXFwLkNvbmZpcm1DaGFubmVsPjtcbiAgZXhjaGFuZ2U6IFByb21pc2U8YW1xcC5SZXBsaWVzLkFzc2VydEV4Y2hhbmdlPjtcbiAgbmFtZTogc3RyaW5nO1xuICBvcHRpb25zOiBFeGNoYW5nZU9wdGlvbnM7XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgQW1xcEV4Y2hhbmdlLlxuICAgKiBAcGFyYW0ge0FtcXBDbGllbnR9IGNsaWVudFxuICAgKiBAcGFyYW0ge1F1ZXVlT3B0aW9uc30gW29wdGlvbnNdXG4gICAqIEBtZW1iZXJvZiBBbXFwRXhjaGFuZ2VcbiAgICovXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY2xpZW50OiBBbXFwQ2xpZW50LCBvcHRpb25zPzogRXhjaGFuZ2VPcHRpb25zKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIC8vIGlmIGRlY29yYXRlZCwgZ2V0IGRlY29yYXRpb25zIGFuZCBtZXJnZVxuICAgIGNvbnN0IG1ldGFkYXRhID0gUmVmbGVjdC5nZXRNZXRhZGF0YShOQU1FX0tFWSwgdGhpcyk7XG4gICAgaWYgKG1ldGFkYXRhKSB7XG4gICAgICB0aGlzLm9wdGlvbnMgPSAgbWV0YWRhdGE7XG4gICAgfVxuXG4gICAgLy8gaWYgb3B0aW9ucyBwYXNzZWQgaW4gbWFudWFsbHksIGV4dGVuZCBvcHRpb25zXG4gICAgaWYgKG9wdGlvbnMpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5vcHRpb25zLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICB0aGlzLm5hbWUgPSB0aGlzLm9wdGlvbnMubmFtZTtcblxuICAgIC8vIGRvIHdlIG5lZWQgb3VyIG93biBjaGFubmVsP1xuICAgIGlmICh0aGlzLm9wdGlvbnMuY2hhbm5lbCkge1xuICAgICAgdGhpcy5jaGFubmVsID0gdGhpcy5jbGllbnQuY3JlYXRlQ2hhbm5lbCh0aGlzLm9wdGlvbnMuY2hhbm5lbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2hhbm5lbCA9IGNsaWVudC5jaGFubmVsO1xuICAgIH1cblxuICAgIHRoaXMuZXhjaGFuZ2UgPSB0aGlzLmNyZWF0ZUV4Y2hhbmdlKCk7XG4gIH1cblxuICAvKipcbiAgICogUHVibGlzaCBhIG1lc3NhZ2UgdG8gdGhlIEV4Y2hhbmdlXG4gICAqXG4gICAqIEBwYXJhbSB7VH0gY29udGVudCBUaGUgY29udGVudCBvZiB0aGUgbWVzc2FnZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gW3JvdXRpbmdLZXk9JyddIFRoZSByb3V0aW5nIGtleSBmb3IgdGhlIG1lc3NhZ2VcbiAgICogQHBhcmFtIHthbXFwLk9wdGlvbnMuUHVibGlzaH0gW29wdGlvbnM9e31dIEFueSBvcHRpb25zIGFkZGVkIHRvIG1lc3NhZ2VcbiAgICogQHJldHVybnMge1Byb21pc2U8Ym9vbGVhbj59IFRydWUgaWYgbWVzc2FnZSBhY2NlcHRlZCwgZmFsc2UgaWYgd3JpdGUgYnVmZmVyIGlzIGZ1bGxcbiAgICogQG1lbWJlcm9mIEFtcXBFeGNoYW5nZVxuICAgKi9cbiAgYXN5bmMgcHVibGlzaChcbiAgICBjb250ZW50OiBULFxuICAgIHJvdXRpbmdLZXk6IHN0cmluZyA9ICcnLFxuICAgIG9wdGlvbnM6IGFtcXAuT3B0aW9ucy5QdWJsaXNoID0ge31cbiAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgY2hubCA9IGF3YWl0IHRoaXMuY2hhbm5lbDtcbiAgICBhd2FpdCB0aGlzLmV4Y2hhbmdlOyAvLyB3YWl0IGZvciBleGNoYW5nZSB0byBiZSBhc3NlcnRlZFxuXG4gICAgbGV0IGJ1ZjogQnVmZmVyO1xuICAgIGlmKHRoaXMub3B0aW9ucy5jb250ZW50VHlwZSA9PT0gJ2FwcGxpY2F0aW9uL2pzb24nKSB7XG4gICAgICBjb25zdCBqc29uID0gSlNPTi5zdHJpbmdpZnkoY29udGVudCk7XG4gICAgICBidWYgPSBuZXcgQnVmZmVyKGpzb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICBidWYgPSBuZXcgQnVmZmVyKGNvbnRlbnQudG9TdHJpbmcoKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNobmwucHVibGlzaChcbiAgICAgIHRoaXMubmFtZSxcbiAgICAgIHJvdXRpbmdLZXksXG4gICAgICBidWYsXG4gICAgICBvcHRpb25zXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGVzIHRoZSBleGNoYW5nZVxuICAgKlxuICAgKiBAcGFyYW0ge2FtcXAuT3B0aW9ucy5EZWxldGVFeGNoYW5nZX0gW29wdGlvbnNdIHsgaWZVbnVzZWQ6IHRydWV8ZmFsc2UgfVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn1cbiAgICogQG1lbWJlcm9mIEFtcXBFeGNoYW5nZVxuICAgKi9cbiAgYXN5bmMgZGVsZXRlRXhjaGFuZ2Uob3B0aW9ucz86IGFtcXAuT3B0aW9ucy5EZWxldGVFeGNoYW5nZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNobmwgPSBhd2FpdCB0aGlzLmNoYW5uZWw7XG4gICAgYXdhaXQgdGhpcy5leGNoYW5nZTsgLy8gd2FpdCBmb3IgZXhjaGFuZ2UgdG8gYmUgYXNzZXJ0ZWRcblxuICAgIGF3YWl0IGNobmwuZGVsZXRlRXhjaGFuZ2UodGhpcy5uYW1lLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCaW5kIHRoaXMgZXhjaGFuZ2UgdG8gYW5vdGhlciBleGNoYW5nZVxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gZGVzdGluYXRpb24gVGhlIG5hbWUgb2YgdGhlIGRlc3RpbmF0aW9uIGV4Y2hhbmdlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXR0ZXJuIFRoZSBwYXR0ZXJuIHRvIG1hdGNoIG1lc3NhZ2VzIHRvIHNlbmRcbiAgICogQHBhcmFtIHsqfSBbYXJnc10gQW55IGFyZ3VtZW50cyAoaGVhZGVycywgZXRjKVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn1cbiAgICogQG1lbWJlcm9mIEFtcXBFeGNoYW5nZVxuICAgKi9cbiAgYXN5bmMgYmluZEV4Y2hhbmdlKGRlc3RpbmF0aW9uOiBzdHJpbmcsIHBhdHRlcm46IHN0cmluZywgYXJncz86IGFueSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNobmwgPSBhd2FpdCB0aGlzLmNoYW5uZWw7XG4gICAgYXdhaXQgdGhpcy5leGNoYW5nZTsgLy8gd2FpdCBmb3IgZXhjaGFuZ2UgdG8gYmUgYXNzZXJ0ZWRcbiAgICBhd2FpdCBjaG5sLmJpbmRFeGNoYW5nZShkZXN0aW5hdGlvbiwgdGhpcy5uYW1lLCBwYXR0ZXJuLCBhcmdzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVbmJpbmQgYW4gZXhjaGFuZ2UgdG8gdGhpcyBleGNoYW5nZVxuICAgKiBUaGUgZGVzdGluYXRpb24sIHBhdHRlcm4sIGFuZCBhcmdzIG11c3QgbWF0Y2ggdGhvc2UgZ2l2ZW4gd2hlbiBleGNoYW5nZSB3YXMgYm91bmRcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGRlc3RpbmF0aW9uIFRoZSBuYW1lIG9mIHRoZSBkZXN0aW5hdGlvbiBleGNoYW5nZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0dGVybiBUaGUgcGF0dGVybiB0byBtYXRjaCBtZXNzYWdlIHRvIHNlbmRcbiAgICogQHBhcmFtIHsqfSBbYXJnc10gQW55IGFyZ3VtZW50cyAoaGVhZGVycywgZXRjKVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn1cbiAgICogQG1lbWJlcm9mIEFtcXBFeGNoYW5nZVxuICAgKi9cbiAgYXN5bmMgdW5iaW5kRXhjaGFuZ2UoZGVzdGluYXRpb246IHN0cmluZywgcGF0dGVybjogc3RyaW5nLCBhcmdzPzogYW55KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY2hubCA9IGF3YWl0IHRoaXMuY2hhbm5lbDtcbiAgICBhd2FpdCB0aGlzLmV4Y2hhbmdlOyAvLyB3YWl0IGZvciBleGNoYW5nZSB0byBiZSBhc3NlcnRlZFxuICAgIGF3YWl0IGNobmwudW5iaW5kRXhjaGFuZ2UoZGVzdGluYXRpb24sIHRoaXMubmFtZSwgcGF0dGVybiwgYXJncyk7XG4gIH1cblxuICAvKipcbiAgICogQmluZCBhIHF1ZXVlIHRvIHRoaXMgZXhjaGFuZ2VcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHF1ZXVlIFRoZSBuYW1lIG9mIHRoZSBxdWV1ZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0dGVybiBUaGUgcGF0dGVybiB0byBtYXRjaCBtZXNzYWdlIHRvIHNlbmRcbiAgICogQHBhcmFtIHsqfSBbYXJnc10gQW55IGFyZ3VlbWVudHMgKGhlYWRlcnMsIGV0YylcbiAgICogQHJldHVybnMge1Byb21pc2U8dm9pZD59XG4gICAqIEBtZW1iZXJvZiBBbXFwRXhjaGFuZ2VcbiAgICovXG4gIGFzeW5jIGJpbmRRdWV1ZShxdWV1ZTogc3RyaW5nLCBwYXR0ZXJuOiBzdHJpbmcsIGFyZ3M/OiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBjaG5sID0gYXdhaXQgdGhpcy5jaGFubmVsO1xuICAgIGF3YWl0IHRoaXMuZXhjaGFuZ2U7IC8vIHdhaXQgZm9yIGV4Y2hhbmdlIHRvIGJlIGFzc2VydGVkXG4gICAgYXdhaXQgY2hubC5iaW5kUXVldWUocXVldWUsIHRoaXMubmFtZSwgcGF0dGVybiwgYXJncyk7XG4gIH1cblxuICAvKipcbiAgICogVW5iaW5kIGEgcXVldWUgdG8gdGhpcyBleGNoYW5nZVxuICAgKiBUaGUgZGVzdGluYXRpb24sIHBhdHRlcm4sIGFuZCBhcmdzIG11c3QgbWF0Y2ggdGhvc2UgZ2l2ZW4gd2hlbiBxdWV1ZSB3YXMgYm91bmRcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHF1ZXVlIFRoZSBuYW1lIG9mIHRoZSBxdWV1ZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0dGVybiBUaGUgcGF0dGVybiB0byBtYXRjaCBtZXNzYWdlIHRvIHNlbmRcbiAgICogQHBhcmFtIHsqfSBbYXJnc10gQW55IGFyZ3VlbWVudHMgKGhlYWRlcnMsIGV0YylcbiAgICogQHJldHVybnMge1Byb21pc2U8YW1xcC5SZXBsaWVzLkVtcHR5Pn1cbiAgICogQG1lbWJlcm9mIEFtcXBFeGNoYW5nZVxuICAgKi9cbiAgYXN5bmMgdW5iaW5kUXVldWUocXVldWU6IHN0cmluZywgcGF0dGVybjogc3RyaW5nLCBhcmdzPzogYW55KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY2hubCA9IGF3YWl0IHRoaXMuY2hhbm5lbDtcbiAgICBhd2FpdCB0aGlzLmV4Y2hhbmdlOyAvLyB3YWl0IGZvciBleGNoYW5nZSB0byBiZSBhc3NlcnRlZFxuICAgIGF3YWl0IGNobmwudW5iaW5kUXVldWUocXVldWUsIHRoaXMubmFtZSwgcGF0dGVybiwgYXJncyk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIHRoZSBFeGNoYW5nZVxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxhbXFwLlJlcGxpZXMuQXNzZXJ0RXhjaGFuZ2U+fVxuICAgKiBAbWVtYmVyb2YgQW1xcEV4Y2hhbmdlXG4gICAqL1xuICBwcml2YXRlIGNyZWF0ZUV4Y2hhbmdlKCk6IFByb21pc2U8YW1xcC5SZXBsaWVzLkFzc2VydEV4Y2hhbmdlPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGNobmwgPSBhd2FpdCB0aGlzLmNoYW5uZWw7XG4gICAgICAgIGNvbnN0IGV4Y2hhbmdlID0gYXdhaXQgY2hubC5hc3NlcnRFeGNoYW5nZSh0aGlzLm9wdGlvbnMubmFtZSwgdGhpcy5vcHRpb25zLnR5cGUsIHRoaXMub3B0aW9ucyk7XG5cbiAgICAgICAgcmVzb2x2ZShleGNoYW5nZSk7XG4gICAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbn1cbiJdfQ==